<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>猜他大爷</title>
    <meta name="viewport" content="initial-scale=1,maximum-scale=1,minimum-scale=1,user-scalable=no" />
    <meta name="format-detection" content="telephone=no,email=no" />
    <link rel="stylesheet" href="./index.css">
    <script src='./draw/js/jq.js'></script>
    <script src='./utils/hysdk.js'></script>
</head>

<body>
    <canvas id="canvas"></canvas>
    <div id='colors'>
        <div class="lineWidthBox"></div>
    </div>
    
    <div id="chatArea">
        <div id="chatBox"></div>
    </div>
    <div class="formbox">
        <input id="message" placeholder="发送消息" />
        <button id="sendBtn">发送</button>
    </div>
    
    <script>
        $('.lineWidthBox').hide();
        $(window).on('click', function(e) {
            if(!$(e.target).hasClass('colorBlock') && !e.target.className.includes('lineBlock')) {
                $('.lineWidthBox').hide();
                $('.arrow').hide();
            }
        })
        // 处理地步输入框
        if (hysdk.sniff.iphoneX) {
            $('.formbox').css({
                height: 80
            });
        }
        $("#message").on('blur', function() {
            $(this).blur();
        })
        function getDom(id) {
            return document.getElementById(id);
        }

        window.ontouchstart = function(e) { e.preventDefault(); };
        document.addEventListener("touchmove", function (e) {
            e.preventDefault()
        }, false);
        var canvas = getDom('canvas'),
            ctx = canvas.getContext('2d');
        canvas.width = document.documentElement.offsetWidth;
        canvas.height = document.documentElement.offsetHeight / 2;
        ctx.lineCap="round";
        ctx.lineJoin="round";
        const colors = [
            '#ffcef3',
            '#a1eafb',
            '#fff591',
            '#f26d5b',
            '#2f89fc'
        ];

        const lineWidth = [
            1,
            5,
            10,
            25,
            35
        ];
        ctx.lineWidth = lineWidth[0];
        ctx.strokeStyle = colors[0];

        colors.forEach(function (color) {
            const colorBlock = $('<div class="colorBlock">');
                colorBlock.append($('<div class="arrow">'))
            $('#colors').append(colorBlock.css({
                backgroundColor: color
            }));
        });

        let colorIndex = 0;
        
        lineWidth.forEach(function (line, index) {

            const lineBox = $('<div class="lineBlockBox">').append($('<div class="lineBlock">').css({
                height: line,
                backgroundColor: colors[colorIndex]
            }));
            
            $('.lineWidthBox').append(lineBox);
        });


        $('#colors').on('click', '.colorBlock' ,function(e) {
            $(this).siblings().removeClass('active');
            $(this).addClass('active');
            colorIndex = $(this).index() - 1;
            ctx.strokeStyle = colors[$(this).index() - 1];
            $('.lineWidthBox').show();
            $(this).find('.arrow').show();
            $('.lineBlock').css({
                backgroundColor: colors[colorIndex]
            })
        });


        $('.lineWidthBox').on('click', '.lineBlockBox' ,function(e) {
            $(this).siblings().removeClass('active');
            $(this).addClass('active');
            ctx.lineWidth = lineWidth[$(this).index()];
        });

        $('#sendBtn').on('click', function() {
            let li = $('<div class="chatItem">');
            li.append($('<span class="nickname">某某：</span>'));
            li.append($('<p class="chatItem_message">').html($('#message').val()));
            $('#chatBox').append(li);
            $('#chatArea').scrollTop($('#chatBox').height());
        });

        
        let isDrawing = false;

        let startX = 0, startY = 0;
        canvas.addEventListener('touchstart', function (e) {
            $('.lineWidthBox').hide();
            $('.arrow').hide();
            var touchPort = e.touches[0];
            var mouseX
            startX = touchPort.pageX;
            startY = touchPort.pageY;
            isDrawing = true;
            ctx.beginPath();
            ctx.moveTo(startX, startY);
        }, false);

        canvas.addEventListener('touchmove', function (e) {
            if (isDrawing) {
                let touchPort = e.touches[0];
                ctx.moveTo(startX, startY);
                ctx.lineTo(touchPort.pageX, touchPort.pageY);
                ctx.closePath();
                ctx.stroke();
                startX = touchPort.pageX;
                startY = touchPort.pageY;
            }
        }, false);

        canvas.addEventListener('touchend', function(e) {
            isDrawing = false;
        });

    </script>
</body>

</html>